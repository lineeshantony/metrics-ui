<!DOCTYPE html>

<!--[if IE 8]> <html lang="en" class="ie8 no-js"> <![endif]-->
<!--[if IE 9]> <html lang="en" class="ie9 no-js"> <![endif]-->
<!--[if !IE]><!-->
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<!--<![endif]-->

<head>
<title>HighCharts Demo</title>
<meta content="This demo shows how to use application metrics"
	name="description" />
<object th:include="fragments/head :: head" th:remove="tag"></object>

<link th:href="@{/assets/pages/css/profile.min.css}" rel="stylesheet"
	type="text/css" />
<link th:href="@{/assets/pages/css/left-side-bar.css}" rel="stylesheet"
	type="text/css" />
</head>


<body class="page-container-bg-solid">
	<div class="page-container main">
		<div class="page-content-wrapper">
			<div class="page-head"
				style="background-color: #eff3f8; padding-top: 40px">
				<div class="container">
					<div class="row" style="margin-bottom: 30px">
						<div class="col-md-6">
							<h1>Business Units - Application Metrics</h1>
						</div>
					</div>
					<div class="row" style="margin-bottom: 30px">
						<div class="sidenav">
							<form action="#" th:action="@{/metricsFilter}"
								th:object="${metricsFilter}" method="post">
								<p>
									<select id="metricTypeSelector" th:field="*{metricsType}">
										<option th:each="metricType : ${metricTypes}"
											th:value="${metricType.id}" th:utext="${metricType.type}" /></option>
									</select>
								</p>
								<p>
									<select th:field="*{businessUnit}">
										<option th:each="businessUnit : ${allSegments}"
											th:value="${businessUnit.value}"
											th:utext="${businessUnit.name}" /></option>
									</select>
								</p>
								<p>
									<input type="submit" value="Submit" />
								</p>
							</form>
						</div>
						<!-- <div class="col-md-6" style="margin-top: 20px">
							<div id="salesByType" style="width: 100%; height: 400px;"></div>
						</div> -->
						<div class="col-md-6" style="margin-top: 20px">
							<div id="chartMetrics" style="width: 100%; height: 400px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div th:include="fragments/homefooter :: footer"></div>
	<script th:inline="javascript">
		/*<![CDATA[*/
		var chartDataString = /*[[${chartData}]]*/;
		var chartData = JSON.parse(chartDataString);
		var metricTypeSelect = document.getElementById("metricTypeSelector");
		var selectedMetricType = metricTypeSelect.options[metricTypeSelect.selectedIndex].value;
		$(function() {
			Highcharts.setOptions({
				lang : {
					decimalPoint : '.',
					thousandsSep : ','
				}
			});
			
			//drawSalesByTypeChart();
			if (selectedMetricType == 3 || selectedMetricType == "3"){
				drawTrendChartComparison();
			} else {
				drawPieChartMetricsChart();
			}
			
		});

		function userAction(componentName) {
		    var xhttp = new XMLHttpRequest();
		    xhttp.onreadystatechange = function() {
		         if (this.readyState == 4 && this.status == 200) {
		        	 chartData = JSON.parse(this.responseText);
		         }
		    };
		    xhttp.open("GET", "/getPieChartData/" + componentName + "/" + selectedMetricType);
		    //xhttp.setRequestHeader("Content-type", "application/json");
		    xhttp.send();
		}
		
		function drawPieChartMetricsChart() {
            var pieChartMetricsChart = Highcharts.chart('chartMetrics', {
                chart: {
                    type: 'pie',
                    margin: 40,
                    options3d: {
                		enabled: true,
                        alpha: 45,
                        beta: 0
                    }
                },
                title: {
                    text: 'Average Build Time (in milliseconds)'
                },
                tooltip: {
                  	pointFormat: "{point.y:,.0f}"
                },
                series: [{
                    name: 'PieChartSeries',
                    colorByPoint:true,
                    point:{
                        events:{
                            click: function (event) {
                                //alert(this.x + " " + this.y);
                                userAction(event.point.name);
                                var chart2 = $('#chartMetrics').highcharts();
                                chart2.series[0].setData(createData());
                                chart2.redraw();
                            }
                        }
                    },   
                    data: (function () {
                       return createData();
                    }())
                    
            	}]
            });
        }

		function createData() {
			var data = [], i;
			var dataJson = chartData;
            var dataArray = dataJson.data;
            for (i = 0; i < dataArray.length; i++) {
            	var dataElement = {
            			name: dataArray[i].name,
                        y: dataArray[i].y
            	};
                data.push(dataElement);
            }
            return data;
		}
		
		function drawTrendChartComparison(){
			var trendComparisonChart = Highcharts.chart('chartMetrics', {

			    title: {
			        text: 'Commit Frequency, Year 2018'
			    },

			    yAxis: {
			        title: {
			            text: 'Number of Commits'
			        }
			    },
			    legend: {
			        layout: 'vertical',
			        align: 'right',
			        verticalAlign: 'middle'
			    },

			    plotOptions: {
			        series: {
			            label: {
			                connectorAllowed: false
			            }
			        }
			    },

			    xAxis: {
			        categories: chartData.categories
			    },
			    
			    series: chartData.dataArray,

			    responsive: {
			        rules: [{
			            condition: {
			                maxWidth: 500
			            },
			            chartOptions: {
			                legend: {
			                    layout: 'horizontal',
			                    align: 'center',
			                    verticalAlign: 'bottom'
			                }
			            }
			        }]
			    }

			});
		}
		
		function drawSalesByTypeChart() {
			var salesByTypeChart = Highcharts.chart('salesByType', {
				chart : {
					type : 'column',
					margin : 75,
					options3d : {
						enabled : true,
						alpha : 15,
						beta : 15,
						depth : 110
					}
				},
				title : {
					text : 'Code Coverage'
				},
				xAxis : {
					categories : [ 'January', 'February', 'March' ]
				},
				yAxis : {
					title : {
						text : 'Coverage (%)'
					}
				},
				tooltip : {
					pointFormat : "{point.y:,.0f}"
				},
				plotOptions : {
					column : {
						depth : 60,
						stacking : true,
						grouping : false,
						groupZPadding : 10
					}
				},
				series : [ {
					name : 'CardNG',
					data : /*[[${CardNG}]]*/[]
				}, {
					name : 'BAPI',
					data : /*[[${BAPI}]]*/[]
				}, {
					name : 'CL',
					data : /*[[${CL}]]*/[]
				} ]
			});
		}
		/*]]>*/
	</script>
</body>
</html>